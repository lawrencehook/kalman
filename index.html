<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2D Kalman Filter Visualization</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <div class="main-container">
        <!-- Controls Panel - Left Side -->
        <div class="controls">

            <div class="slider-container">
                <label data-tooltip="Current simulation time. The filter runs at 20Hz (every 0.05s) while measurement frequency is configurable via the Measurement Rate Ratio slider.">Time:</label>
                <input type="range" id="timeSlider" min="0" max="100" value="0" step="1">
                <span class="value" id="timeValue">0.00s</span>
            </div>

            <div class="slider-container">
                <label data-tooltip="Standard deviation of noise added to position measurements. Higher values make measurements less reliable, causing the filter to trust its model more.">Measurement Noise (σ):</label>
                <input type="range" id="measurementNoise" min="1" max="50" value="5" step="1">
                <span class="value" id="measurementNoiseValue">15</span>
            </div>

            <div class="slider-container">
                <label data-tooltip="Uncertainty in the motion model. Higher values mean the filter expects more random accelerations, making it trust measurements more and predictions less.">Process Noise:</label>
                <input type="range" id="processNoise" min="0.1" max="5" value="1" step="0.1">
                <span class="value" id="processNoiseValue">1.0</span>
            </div>

            <div class="slider-container">
                <label data-tooltip="How often measurements arrive relative to predictions. Higher values = more frequent measurements. Currently prediction rate is 20Hz (every 0.05s).">Measurement Rate Ratio:</label>
                <input type="range" id="measurementRatio" min="0.5" max="8" value="2" step="0.5">
                <span class="value" id="measurementRatioValue">2.0x</span>
            </div>


            <!-- Filter Equations Section - Content generated by FilterUIManager -->
            <div class="filter-equations">
                <!-- Filter-specific equations will be dynamically inserted here -->
            </div>
        </div>

        <!-- Visualization Container - Center -->
        <div class="viz-container">
            <!-- Canvas with overlays -->
            <div class="canvas-wrapper">
                <canvas id="canvas" width="650" height="450"></canvas>
                
                <!-- Custom Dropdowns -->
                <div class="canvas-dropdowns">
                    <div id="filter-dropdown-container" class="canvas-dropdown-container"></div>
                    <div id="trajectory-dropdown-container" class="canvas-dropdown-container"></div>
                </div>
                
                <!-- Overlay Legend -->
                <div class="canvas-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #0f0;"></div>
                        <span>Ground Truth</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #f0f;"></div>
                        <span>Measurements</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #0ff; width: 6px; height: 6px; border-radius: 3px;"></div>
                        <span>Kalman Estimates</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: rgba(0,255,255,0.3);"></div>
                        <span>95% Confidence</span>
                    </div>
                </div>
                
                <!-- Overlay Control Buttons -->
                <div class="canvas-controls">
                    <button id="playBtn">Play/Pause</button>
                    <button id="stepBtn">Step</button>
                    <button id="resetBtn">Reset</button>
                </div>
            </div>

            <!-- Error Graph -->
            <div class="error-graph-container">
                <h3 style="text-align: center; color: #4af; margin: 10px 0 5px 0; font-size: 14px;">Position Error vs 95% Confidence Bound</h3>
                <canvas id="errorGraph" width="650" height="150"></canvas>
                <div class="error-legend">
                    <div class="legend-item">
                        <span data-tooltip="Coverage over the entire simulated duration: fraction of timestamps where ground truth is inside the estimate's 95% error ellipse (Mahalanobis distance² ≤ 5.991)." style="cursor: help;">
                            Total 95% Coverage: <span id="total-coverage-95" style="color: #4af; font-weight: bold;">--</span>
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dynamic Filter State Panel - Content generated by FilterUIManager -->
        <div class="state-panel">
            <!-- Filter-specific UI will be dynamically inserted here -->
        </div>
    </div>

    <!-- Dynamic System Matrices Section - Content generated by FilterUIManager -->
    <div class="system-matrices">
        <!-- Filter-specific matrices and equations will be dynamically inserted here -->
    </div>

    <!-- Core utilities (no dependencies) -->
    <script src="scripts/utils/matrix-utils.js"></script>
    <script src="scripts/utils/noise-utils.js"></script>

    <!-- Trajectory generators -->
    <script src="scripts/trajectory/trajectory-base.js"></script>
    <script src="scripts/trajectory/geometric-generators.js"></script>
    <script src="scripts/trajectory/physics-generators.js"></script>
    <script src="scripts/trajectory/mathematical-generators.js"></script>
    <script src="scripts/trajectory/random-generators.js"></script>

    <!-- Filter registry system -->
    <script src="scripts/filters/filter-registry.js"></script>
    
    <!-- Filter implementations -->
    <script src="scripts/filters/filter-base.js"></script>
    <script src="scripts/filters/kalman-filter-2d/kalman-filter-2d.js"></script>
    <script src="scripts/filters/imm/imm-filter.js"></script>

    <!-- UI components -->
    <script src="scripts/ui/matrix-renderer.js"></script>
    <script src="scripts/ui/state-renderer.js"></script>
    <script src="scripts/ui/equation-renderer.js"></script>
    <script src="scripts/ui/custom-dropdown.js"></script>
    <script src="scripts/ui/filter-ui-manager.js"></script>
    <script src="scripts/ui/tooltip-system.js"></script>

    <!-- Filter-specific UI configurations -->
    <script src="scripts/filters/kalman-filter-2d/kalman-ui-config.js"></script>
    <script src="scripts/filters/imm/imm-ui-config.js"></script>
    
    <!-- Filter module exports (must be loaded after UI configs) -->
    <script src="scripts/filters/kalman-filter-2d/index.js"></script>
    <script src="scripts/filters/imm/index.js"></script>

    <!-- Visualization components -->
    <script src="scripts/visualization/visualization-engine.js"></script>
    <script src="scripts/visualization/error-graph.js"></script>
    <script src="scripts/visualization/state-display.js"></script>

    <!-- Controllers -->
    <script src="scripts/controllers/simulation-controller.js"></script>
    <script src="scripts/controllers/ui-controller.js"></script>

    <!-- Application startup -->
    <script src="scripts/app.js"></script>
</body>
</html>